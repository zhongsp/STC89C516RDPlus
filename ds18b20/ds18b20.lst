C51 COMPILER V9.60.0.0   DS18B20                                                           06/27/2022 19:37:44 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN ds18b20.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE App\ds18b20.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\App;.\Public) DEBUG OBJE
                    -CTEXTEND PRINT(.\ds18b20.lst) OBJECT(ds18b20.obj)

line level    source

   1          #include "ds18b20.h"
   2          
   3          u8 ds18b20_init(void)
   4          {
   5   1      ds18b20_reset();
   6   1      return ds18b20_check();
   7   1      }
   8          
   9          void ds18b20_reset(void)
  10          {
  11   1          // 主机输出低电平
  12   1          DS18B20_PORT = 0;
  13   1          
  14   1          // 保持低电平 480-960us
  15   1          delay_10us(75);
  16   1          
  17   1          // 主机释放总线，上拉电阻将总线拉高电平
  18   1          DS18B20_PORT = 1;
  19   1          
  20   1          // 操持高电平 15 - 60us
  21   1          delay_10us(2);
  22   1      }
  23          
  24          u8 ds18b20_check(void)
  25          {
  26   1          u8 time_temp = 0;
  27   1          
  28   1          // 如果有 ds18b20 器件，在复位后，它会产生一个低电平
  29   1          while (DS18B20_PORT && time_temp < 20)
  30   1          {
  31   2              time_temp++;
  32   2              delay_10us(1);
  33   2          }
  34   1          
  35   1          if (time_temp >= 20)
  36   1              return 1;
  37   1          else
  38   1              time_temp = 0;
  39   1          
  40   1          while ((!DS18B20_PORT) && time_temp < 20)
  41   1          {
  42   2              time_temp++;
  43   2              delay_10us(1);
  44   2          }
  45   1          if (time_temp >= 20) return 1;
  46   1          return 0;
  47   1      }
  48          
  49          float ds18b20_read_temperture(void)
  50          {
  51   1          float temp;
  52   1          u8 dath = 0;
  53   1          u8 datl = 0;
  54   1          u16 value = 0;
C51 COMPILER V9.60.0.0   DS18B20                                                           06/27/2022 19:37:44 PAGE 2   

  55   1          
  56   1          ds18b20_start();
  57   1          ds18b20_reset();
  58   1          ds18b20_check();
  59   1          
  60   1          // skip rom
  61   1          ds18b20_write_byte(0xcc);
  62   1          
  63   1          // read memory
  64   1          ds18b20_write_byte(0xbe);
  65   1          
  66   1          datl=ds18b20_read_byte();
  67   1          dath=ds18b20_read_byte();
  68   1          value = (dath<<8)+datl;
  69   1          
  70   1          if ((value & 0xf800) == 0xf800)
  71   1          {
  72   2              value = (~value) + 1;
  73   2              temp = value * 0.0625;
  74   2          }
  75   1          return temp;
  76   1      }
  77          
  78          void ds18b20_start(void)
  79          {
  80   1          ds18b20_reset();
  81   1          ds18b20_check();
  82   1          ds18b20_write_byte(0xcc);
  83   1          ds18b20_write_byte(0x44);
  84   1      }
  85          
  86          void ds18b20_write_byte(u8 dat)
  87          {
  88   1          u8 i = 0;
  89   1          for (i = 0; i < 8; i++)
  90   1          {
  91   2              if ((dat & 0x80) > 0)
  92   2              {
  93   3                  // write 1
  94   3                  DS18B20_PORT = 0;
  95   3                  delay_2us();
  96   3                  DS18B20_PORT = 1;
  97   3                  delay_10us(6);
  98   3              }
  99   2              else
 100   2              {
 101   3                  // write 0
 102   3                  DS18B20_PORT = 0;
 103   3                  delay_10us(6);
 104   3                  DS18B20_PORT = 1;
 105   3                  delay_2us();
 106   3              }
 107   2              
 108   2              dat<<=1;
 109   2          }
 110   1      }
 111          
 112          u8 ds18b20_read_byte(void)
 113          {
 114   1          u8 dat = 0;
 115   1          u8 i = 0;
 116   1          u8 value = 0;
C51 COMPILER V9.60.0.0   DS18B20                                                           06/27/2022 19:37:44 PAGE 3   

 117   1          
 118   1          for (i = 0; i< 8; i++)
 119   1          {
 120   2              DS18B20_PORT = 0;
 121   2              delay_2us();
 122   2              DS18B20_PORT = 1;
 123   2              delay_10us(1);
 124   2              delay_2us();
 125   2              value = DS18B20_PORT;
 126   2              if (DS18B20_PORT == 0)
 127   2              {
 128   3                  dat >>= 1;
 129   3              }
 130   2              else
 131   2              {
 132   3                  dat >>= 1;
 133   3                  dat |= 0x80;
 134   3              }
 135   2              delay_10us(5);
 136   2          }
 137   1          
 138   1          return dat;
 139   1      }
 140          
 141          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    373    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      11
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
